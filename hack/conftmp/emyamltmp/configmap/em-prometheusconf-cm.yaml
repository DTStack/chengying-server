
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheusconf
  namespace: {{.NameSpace}}
data:
 prometheus.yml: "# my global config\nglobal:\n  scrape_interval:     30s\n  evaluation_interval: 1m\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n      - alertmanager:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  - /prometheus/rules/*\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  - job_name: 'host_node_exporter'\n    file_sd_configs:\n    - files: ['/prometheus/node_sd_file.yml']\n      refresh_interval: 1m\n  - job_name: 'host_em_service'\n    file_sd_configs:\n    - files: ['/prometheus/service_sd_file.yml']\n      refresh_interval: 30s\n  - job_name: 'kube_em_service'\n    kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n          - {{.NameSpace}}\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n      action: keep\n      regex: true\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n      action: replace\n      target_label: __scheme__\n      regex: (https?)\n    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n      action: replace\n      target_label: __metrics_path__\n      regex: (.+)\n    - source_labels: [__address__,__meta_kubernetes_service_annotation_prometheus_io_port]\n      action: replace\n      target_label: __address__\n      regex: ([^:]+)(?::[0-9]+)?;([0-9]+)\n      replacement: $1:$2\n    - action: labelmap\n      regex: __meta_kubernetes_pod_label_(.+)\n    - source_labels: [__meta_kubernetes_namespace]\n      action: replace\n      target_label: kubernetes_namespace\n    - source_labels: [__meta_kubernetes_pod_name]\n      action: replace\n      target_label: kubernetes_pod_name \n  - job_name: 'promtail'\n    kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n          - {{.NameSpace}}\n    relabel_configs:\n    - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_scrape,__meta_kubernetes_pod_container_name ]\n      action: keep\n      regex: true;promtail\n    - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_scheme ]\n      action: replace\n      target_label: __scheme__\n      regex: (https?)\n    - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_path ]\n      action: replace\n      target_label: __metrics_path__\n      regex: (.+)\n    - source_labels: [ __address__, __meta_kubernetes_service_annotation_prometheus_io_port ]\n      action: replace\n      target_label: __address__\n      regex: ([^:]+)(?::[0-9]+)?;([0-9]+)\n      replacement: $1:3101\n    - action: labelmap\n      regex: __meta_kubernetes_service_label_(.+)\n    - source_labels: [ __meta_kubernetes_namespace ]\n      action: replace\n      target_label: kubernetes_namespace\n    - source_labels: [ __meta_kubernetes_service_name ]\n      action: replace\n      target_label: kubernetes_name\n    - source_labels: [ __meta_kubernetes_pod_name ]\n      action: replace\n      target_label: kubernetes_pod_name\n    - target_label: service_name\n      replacement: promtail\n      source_labels: [ service_name ]\n      action: replace\n    - target_label: service_version\n      replacement: dt-2.1.0\n      source_labels: [ service_version ]\n      action: replace\n"
